image: python:3.5

definitions:
  steps:
    step: &run-tests
      caches:
        - pip
      script:
        - apt-get -y -qq update || true
        - apt-get -y -qq install mercurial
        - pip install .[ci]
        - tox -e py$((34+${BITBUCKET_PARALLEL_STEP}))
        - python setup.py bdist_wheel sdist

pipelines:
  default:
    - parallel:
      - step:
          <<: *run-tests
          image: python:3.4
      - step:
          <<: *run-tests
          image: python:3.5
      - step:
          <<: *run-tests
          image: python:3.6
      - step:
          <<: *run-tests
          image: python:3.7
    - step:
        name: Deploy to TestPyPI
        deployment: test
        script:
          - apt-get -y -qq update || true
          - apt-get -y -qq install mercurial
          - pipe: atlassian/pypi-publish:0.2.3
            variables:
              PYPI_USERNAME: $PYPI_USERNAME
              PYPI_PASSWORD: $PYPI_PASSWORD
              DISTRIBUTIONS: 'sdist bdist_wheel'
              REPOSITORY: https://test.pypi.org/legacy/
    - step:
        name: Deploy to PyPI
        deployment: production
        trigger: manual
        script:
          - apt-get -y -qq update || true
          - apt-get -y -qq install mercurial
          - pipe: atlassian/pypi-publish:0.2.3
            variables:
              PYPI_USERNAME: $PYPI_USERNAME
              PYPI_PASSWORD: $PYPI_PASSWORD
              DISTRIBUTIONS: 'sdist bdist_wheel'
